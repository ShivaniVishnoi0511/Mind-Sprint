<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mind Sprint</title>
  <link rel="stylesheet" href="style1.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Carter+One&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Lilita+One&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    
  <div class="loader" id="loader"><p>PLEASE WAIT.....</p>While The Quiz Starts</div>

  <nav>
    <span id="welcome">Welcome, <span id="username"></span></span>
    <div class="navs">
      <div class="navbar">
        <i id="icon" class="fa-solid fa-xmark fa-2xl" style="color: #a146b0;"></i>
        <button id="statbutton">Status</button>
      </div>
      <button class="next" id="end">End</button>
    </div>
  </nav>

  <div id="header">
    <p id="scoretext">SCORE : <span id="score"> 0</span></p>
    <div id="timer">Time Left: 05:00</div>
  </div>

  <div class="container" id="container">
    <div class="content">
      <div id="ques">
        <h2><span id="quesno"></span></h2>
        <div class="choice"><p class="option">A</p><button class="value" data-number="1"></button></div>
        <div class="choice"><p class="option">B</p><button class="value" data-number="2"></button></div>
        <div class="choice"><p class="option">C</p><button class="value" data-number="3"></button></div>
        <div class="choice"><p class="option">D</p><button class="value" data-number="4"></button></div>

        <div class="buttons">
          <button id="review">Mark for review</button>
          <button id="submit">Submit</button>
        </div>
        <div class="button"><button id="next" class="next">NEXT</button></div>
      </div>
    </div>

    <div class="status" id="status1">
      <div><span class="text" id="attempt">Attempted: 0</span></div>
      <div><span class="text" id="unattempt">Unattempted: 12</span></div>
      <div><span class="text" id="reviewbutton">Marked for review: 0</span></div>
      <div class="progress" id="progress"></div>
    </div>
  </div>

  <script>
    function decodeHTML(html) {
      const txt = document.createElement("textarea");
      txt.innerHTML = html;
      return txt.value;
    }

    const username = localStorage.getItem("username");
    if (username) document.getElementById("username").textContent = username;

    const value = document.getElementsByClassName("value");
    const choices = Array.from(document.getElementsByClassName("choice"));
    const question = document.getElementById("ques");
    const optionLabels = Array.from(document.querySelectorAll(".choice .option"));
    let currques = {};
    let accans = true;
    let quesCount = 0;
    let availquest = [];
    let questions = [];
    let score = 0;
    let attempt = 0;
    const maxques = 12;
    let unattempt = maxques;
    let review = 0;
    let selchoice = null;

    choices.forEach(choice => {
      choice.addEventListener("click", event => {
        if (!accans) return;
        if (selchoice) selchoice.style.backgroundColor = "#efe9e9";
        accans = false;
        const sel = event.target;
        selchoice = sel;
        sel.style.backgroundColor = "blue";
      });
    });

    document.getElementById("submit").addEventListener("click", () => {
      const selans = selchoice?.dataset["number"];
      if (!selans) return;
      if (selans == currques.answer) {
        selchoice.style.backgroundColor = "green";
        score += 4;
      } else {
        selchoice.style.backgroundColor = "red";
        score -= 1;
      }

      setTimeout(() => {
        selchoice.style.backgroundColor = "#efe9e9";
        newques();
      }, 2000);

      selchoice = null;
      document.getElementById("score").textContent = score;
      localStorage.setItem("score", score);
      attempt++;
      unattempt--;
      document.getElementById("attempt").textContent = `Attempted :${attempt}`;
      document.getElementById("unattempt").textContent = `Unattempted :${unattempt}`;
      const quesnum = document.querySelector(`[id="${quesCount}"]`);
      quesnum.style.backgroundColor = "green";
    });

    document.getElementById("review").addEventListener("click", () => {
      review++;
      unattempt--;
      document.getElementById("reviewbutton").textContent = `Marked for review :${review}`;
      const quesnum = document.querySelector(`[id="${quesCount}"]`);
      quesnum.style.backgroundColor = "purple";
      setTimeout(() => newques(), 2000);
    });

    document.getElementById("end").addEventListener("click", () => {
      addScore(username, score);
      window.location.assign("end.html");
    });

    const timeLimit = 5 * 60 * 1000;
    function endtest() {
      document.getElementById("end").click();
    }

    function starttime() {
      setTimeout(() => endtest(), timeLimit);
    }

    document.getElementById("next").addEventListener("click", () => newques());

    function start() {
      score = 0;
      quesCount = 0;
      availquest = [...questions];
      newques();
    }

    function newques() {
      if (quesCount < maxques) {
        quesCount++;
        const quesindex = Math.floor(Math.random() * availquest.length);
        currques = availquest[quesindex];
        const questionElement = document.querySelector("h2");
        questionElement.textContent = `${quesCount}. ${currques.question}`;
        questionElement.id = `ques${quesCount}`;
        choices.forEach((choice, index) => {
          const label = choice.querySelector(".option");
          const option = choice.querySelector(".value");
          label.textContent = String.fromCharCode(65 + index);
          option.textContent = currques["choosen" + (index + 1)];
        });
        availquest.splice(quesindex, 1);
        accans = true;
        if (quesCount == maxques) {
          document.getElementById("next").style.display = "none";
        }
      } else {
        window.location.assign("end.html");
      }
    }

    let time = 5 * 60;
    const timer = document.getElementById("timer");
    function timedisp() {
      const min = Math.floor(time / 60);
      const sec = time % 60;
      timer.textContent = `Time Left: 0${min}:${sec < 10 ? "0" + sec : sec}`;
      if (time < 30) timer.style.color = "red";
    }

    setTimeout(() => {
      alert("Hurry Up!! \n Test is going to end soon");
    }, 270000);

    const container = document.getElementById("container");
    const statbutton = document.getElementById("statbutton");
    const status1 = document.getElementById("status1");
    const icon = document.getElementById("icon");

    statbutton.addEventListener("click", () => {
      status1.style.display = "flex";
      container.style.display = "grid";
      icon.style.display = "block";
      statbutton.style.display = "none";
    });

    icon.addEventListener("click", () => {
      container.style.display = "block";
      status1.style.display = "none";
      icon.style.display = "none";
      statbutton.style.display = "block";
    });

    function save(highScores) {
      localStorage.setItem("highScores", JSON.stringify(highScores));
    }

    function addScore(username, score) {
      const highScores = JSON.parse(localStorage.getItem("highScores")) || [];
      highScores.push({ name: username, score: score });
      highScores.sort((a, b) => b.score - a.score);
      highScores.splice(3);
      save(highScores);
    }

    const progress = document.getElementById("progress");
    for (let i = 1; i <= 12; i++) {
      let span = document.createElement("span");
      span.id = i;
      span.className = "span";
      span.textContent = i;
      progress.appendChild(span);
    }

    const Spans = Array.from(progress.querySelectorAll(".span"));
    Spans.forEach((span, index) => {
      span.addEventListener("click", () => {
        if (index < questions.length) {
          quesCount = index;
          newques();
        }
      });
    });

    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById("loader").style.display = "flex";

      fetch("https://opentdb.com/api.php?amount=20&category=21&difficulty=medium&type=multiple")
        .then(response => response.json())
        .then(data => {
          questions = data.results.map((data, index) => {
            const questdisp = {
              id: index + 1,
              question: decodeHTML(data.question),
              answer: Math.floor(Math.random() * 4) + 1
            };

            const choices = [...data.incorrect_answers.map(decodeHTML)];
            choices.splice(questdisp.answer - 1, 0, decodeHTML(data.correct_answer));

            for (let i = 1; i <= 4; i++) {
              questdisp["choosen" + i] = choices[i - 1];
            }

            return questdisp;
          });

          start();
          document.getElementById("loader").style.display = "none";
          starttime();

          setInterval(() => {
            if (time <= 1) {
              timer.textContent = "TIME'S UP";
            } else {
              time--;
              timedisp();
            }
          }, 1000);
        })
        .catch(error => {
          console.error(error);
        });
    });
  </script>
</body>
</html>
